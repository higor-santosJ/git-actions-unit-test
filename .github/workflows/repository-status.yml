name: Repository Info
on:
  push:
    branches:
      - main
      - development
  pull_request:
    branches:
      - main
      - development
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * *"

jobs:
  get_pull_requests_and_reviewers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get Pull Requests
        id: pull_requests
        run: |
          pull_requests=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls?state=open")
          echo "COUNT=$(echo "$pull_requests" | jq length)" >> $GITHUB_ENV
          echo "TITLES=$(echo "$pull_requests" | jq -r '.[].title')" >> $GITHUB_ENV
          echo "URLS=$(echo "$pull_requests" | jq -r '.[].url')" >> $GITHUB_ENV

      - name: Get Reviewers
        id: reviewers
        run: |
          pull_request_urls=(${{ env.URLS }})
          reviewer_info=""
          for url in "${pull_request_urls[@]}"; do
            reviewers=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$url/requested_reviewers")
            reviewer_names=$(echo "$reviewers" | jq -r '.[].user.login')
            reviewer_info+="Pull Request: $url | Reviewers: $reviewer_names"$'\n'
          done
          echo "REVIEWERS=$reviewer_info" >> $GITHUB_ENV

  display_results:
    needs: get_pull_requests_and_reviewers
    runs-on: ubuntu-latest
    steps:
      - name: Display Results
        run: |
          echo "Pull Requests:"
          echo "Count: ${{ env.COUNT }}"
          echo "Titles: ${{ env.TITLES }}"
          echo ""
          echo "Reviewers:"
          echo "${{ env.REVIEWERS }}"